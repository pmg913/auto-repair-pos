// JavaScript logic to support 3 bays per time slot and service type

const calendarData = {
  quick: {},
  major: {}
};

let uncheckedAppointments = [];

function getCurrentDateKey() {
  const input = document.getElementById('calendarDate');
  return input && input.value ? input.value : new Date().toISOString().split('T')[0];
}

function getSlotKey(serviceType, day, time) {
  return `${getCurrentDateKey()}_${serviceType}_${day}_${time}`;
}

function generateTimeSlots() {
  const calendarTypes = ['quick', 'major'];
  const timeStart = 8 * 60;
  const timeEnd = 17 * 60;
  const interval = 15;
  const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
  uncheckedAppointments = [];

  calendarTypes.forEach(type => {
    const tbody = document.getElementById(`calendarBody-${type}`);
    tbody.innerHTML = '';

    for (let t = timeStart; t < timeEnd; t += interval) {
      const row = document.createElement('tr');
      const timeStr = `${String(Math.floor(t / 60)).padStart(2, '0')}:${String(t % 60).padStart(2, '0')}`;

      const timeCell = document.createElement('td');
      timeCell.textContent = timeStr;
      row.appendChild(timeCell);

      days.forEach(day => {
        const key = getSlotKey(type, day.toLowerCase(), timeStr);
        if (!calendarData[type][key]) calendarData[type][key] = [];

        const cell = document.createElement('td');

        const appts = calendarData[type][key];
        appts.forEach((appt, i) => {
          const div = document.createElement('div');
          div.textContent = `${appt.name} (${appt.status || 'Scheduled'})`;
          div.setAttribute('data-tooltip', `Phone: ${appt.phone}\nVehicle: ${appt.vehicle}`);
          div.setAttribute('data-status', appt.status);

          div.onclick = (e) => {
            e.stopPropagation();
            const nextStatus = prompt("Update status: Scheduled, In Progress, Completed", appt.status);
            if (nextStatus) {
              appt.status = nextStatus;
              generateTimeSlots();
              saveAppointments();
            }
          };

          if (appt.status !== 'Completed') {
            uncheckedAppointments.push({ ...appt, day, time: timeStr, service: type });
          }

          cell.appendChild(div);
        });

        cell.onclick = () => {
          if (calendarData[type][key].length >= 3) {
            alert('All 3 bays are booked for this time.');
          } else {
            const name = prompt('Enter client name:');
            const phone = prompt('Enter phone:');
            const vehicle = prompt('Enter vehicle:');
            if (name && phone && vehicle) {
              calendarData[type][key].push({ name, phone, vehicle, status: 'Scheduled' });
              generateTimeSlots();
              saveAppointments();
            }
          }
        };

        row.appendChild(cell);
      });
      tbody.appendChild(row);
    }
  });
  displayUnchecked();
}

function displayUnchecked() {
  const section = document.getElementById('uncheckedList') || document.createElement('div');
  section.id = 'uncheckedList';
  section.innerHTML = '<h3>Unfinished Appointments</h3>';
  uncheckedAppointments.forEach(appt => {
    const div = document.createElement('div');
    div.textContent = `${appt.name} (${appt.status}) - ${appt.service} on ${appt.day} at ${appt.time}`;
    section.appendChild(div);
  });
  document.body.appendChild(section);
}

function saveAppointments() {
  localStorage.setItem('calendarData', JSON.stringify(calendarData));
}

function loadAppointments() {
  const saved = localStorage.getItem('calendarData');
  if (saved) {
    Object.assign(calendarData, JSON.parse(saved));
  }
}

function changeDate(offset) {
  const input = document.getElementById('calendarDate');
  const current = new Date(input.value || new Date());
  current.setDate(current.getDate() + offset);
  input.value = current.toISOString().split('T')[0];
  generateTimeSlots();
}

window.onload = () => {
  const dateInput = document.getElementById('calendarDate');
  if (!dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];
  loadAppointments();
  generateTimeSlots();
};
